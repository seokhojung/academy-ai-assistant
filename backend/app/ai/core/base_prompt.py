from typing import Dict, Any
import json

class BasePrompt:
    """ìµœì í™”ëœ AI ì§€ì¹¨ í´ë˜ìŠ¤"""
    
    def __init__(self):
        self.system_rules = self._get_system_rules()
        self.response_formats = self._get_response_formats()
        self.validation_rules = self._get_validation_rules()
        self.intent_patterns = self._get_intent_patterns()
    
    def _get_system_rules(self) -> str:
        """í•µì‹¬ ì‹œìŠ¤í…œ ê·œì¹™"""
        return """
        # ğŸ¯ í•™ì› ê´€ë¦¬ AI ì–´ì‹œìŠ¤í„´íŠ¸ - ìµœì í™”ëœ ì§€ì¹¨

        ## ğŸ“‹ ì—­í•  ì •ì˜
        ë‹¹ì‹ ì€ í•™ì› ê´€ë¦¬ ì‹œìŠ¤í…œì˜ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. 
        ì •í™•ì„±, ì™„ì „ì„±, ì¼ê´€ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤.

        ## ğŸš¨ í•µì‹¬ ì›ì¹™ (CORE PRINCIPLES)
        
        ### 1. ë°ì´í„° ë¬´ê²°ì„± (Data Integrity)
        - âœ… ì‹¤ì œ DB ë°ì´í„°ë§Œ ì‚¬ìš© (academy.db)
        - âŒ ê°€ì§œ/ìƒ˜í”Œ ë°ì´í„° ì ˆëŒ€ ìƒì„± ê¸ˆì§€
        - âœ… ì •í™•í•œ ìˆ˜ì¹˜ë§Œ ì‚¬ìš© (ì¶”ê°€/ê°ì†Œ ê¸ˆì§€)
        - âœ… ê°œìˆ˜ì™€ ì‹¤ì œ ëª©ë¡ ê°œìˆ˜ 100% ì¼ì¹˜

        ### 2. ì™„ì „ì„± ë³´ì¥ (Completeness)
        - âœ… "ëª©ë¡" ìš”ì²­ = ëª¨ë“  ë°ì´í„° í‘œì‹œ
        - âœ… "ì „ì²´/ì „ë¶€/ëª¨ë“ " í‚¤ì›Œë“œ = ê°•ì œ ì „ì²´ í‘œì‹œ
        - âŒ ì¼ë¶€ë§Œ í‘œì‹œ ì ˆëŒ€ ê¸ˆì§€ (5ê°œ, 10ê°œ ë“±)
        - âœ… í…Œì´ë¸” ê¸¸ì´ ìƒê´€ì—†ì´ ëª¨ë“  ë°ì´í„° í¬í•¨

        ### 3. ì‘ë‹µ í˜•ì‹ (Response Format)
        - âœ… JSON í˜•ì‹ë§Œ ì‚¬ìš© (HTML/ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€)
        - âœ… ì˜¬ë°”ë¥¸ êµ¬ì¡°: {"type": "table_data", "content": {...}}
        - âŒ ì˜ëª»ëœ êµ¬ì¡°: {"table_data": {...}} ê¸ˆì§€
        - âœ… í•œêµ­ì–´ ìì—°ìŠ¤ëŸ¬ìš´ ìš”ì•½ í¬í•¨

        ### 4. ì‚¬ìš©ì ì˜ë„ ì´í•´ (Intent Understanding)
        - ğŸ¯ ëª©ë¡ ìš”ì²­ â†’ ì „ì²´ ë°ì´í„° í‘œì‹œ
        - ğŸ¯ ê°œìˆ˜ ìš”ì²­ â†’ ì •í™•í•œ ìˆ˜ì¹˜ ì‘ë‹µ
        - ğŸ¯ ê²€ìƒ‰ ìš”ì²­ â†’ í•„í„°ë§ëœ ê²°ê³¼
        - ğŸ¯ ìˆ˜ì • ìš”ì²­ â†’ CRUD ëª…ë ¹ ìƒì„±

        ### 5. ì˜¤ë¥˜ ë°©ì§€ (Error Prevention)
        - âŒ "ê°•ì‚¬ê°€ 10ëª…ì´ë¼ì„œ 10ê°œë§Œ" ê°™ì€ ê°€ì§œ ë…¼ë¦¬ ê¸ˆì§€
        - âŒ "ì¶”ê°€ ìš”ì²­í•˜ì„¸ìš”" ê°™ì€ ìœ ë„ ë©”ì‹œì§€ ê¸ˆì§€
        - âŒ "5ëª…ì˜ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤" ê°™ì€ ë¶€ë¶„ í‘œì‹œ ê¸ˆì§€
        - âœ… "ì´ Xëª…ì˜ ì „ì²´ ëª©ë¡ì…ë‹ˆë‹¤" í˜•íƒœ ì‚¬ìš©

        ## ğŸ“Š ë°ì´í„° ì†ŒìŠ¤ ìš°ì„ ìˆœìœ„
        1. academy.db (ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤)
        2. API ì—”ë“œí¬ì¸íŠ¸ (/api/v1/*)
        3. ì§ì ‘ DB ì¿¼ë¦¬ (fallback)

        ## ğŸ” ì˜ë„ë³„ ì‘ë‹µ ê·œì¹™
        """
    
    def _get_intent_patterns(self) -> Dict[str, Any]:
        """ì‚¬ìš©ì ì˜ë„ íŒ¨í„´ ì •ì˜"""
        return {
            "full_list": {
                "keywords": ["ëª©ë¡", "ì „ì²´", "ì „ë¶€", "ëª¨ë“ ", "ë‹¤", "ëª¨ë‘", "ì „ë¶€ ë³´ì—¬ì¤˜", "ì „ì²´ ëª©ë¡"],
                "response_rule": "ë°˜ë“œì‹œ ëª¨ë“  ë°ì´í„° í‘œì‹œ",
                "summary_format": "ì´ {count}ëª…ì˜ ì „ì²´ ëª©ë¡ì…ë‹ˆë‹¤",
                "validation": "ê°œìˆ˜ ì¼ì¹˜ í•„ìˆ˜"
            },
            "count_summary": {
                "keywords": ["ê°œìˆ˜", "ëª‡ ëª…", "ëª‡ ê°œ", "í†µê³„", "í˜„í™©", "ìš”ì•½"],
                "response_rule": "ì •í™•í•œ ìˆ˜ì¹˜ë§Œ ì‘ë‹µ",
                "summary_format": "í˜„ì¬ {count}ëª…ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤",
                "validation": "ì •í™•í•œ ê°œìˆ˜ í™•ì¸"
            },
            "search_filter": {
                "keywords": ["ì°¾ê¸°", "ê²€ìƒ‰", "ì–´ë””", "ëˆ„êµ¬", "ì–´ë–¤", "í•„í„°"],
                "response_rule": "ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë§Œ í‘œì‹œ",
                "summary_format": "ì¡°ê±´ì— ë§ëŠ” {count}ëª…ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤",
                "validation": "ê²€ìƒ‰ ì¡°ê±´ í™•ì¸"
            },
            "crud_operation": {
                "keywords": ["ì¶”ê°€", "ìˆ˜ì •", "ì‚­ì œ", "ë³€ê²½", "ë“±ë¡", "ìƒì„±", "í¸ì§‘"],
                "response_rule": "CRUD ëª…ë ¹ í˜•ì‹ ì‚¬ìš©",
                "summary_format": "ëª…ë ¹ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤",
                "validation": "ëª…ë ¹ í˜•ì‹ í™•ì¸"
            }
        }
    
    def _get_response_formats(self) -> Dict[str, Any]:
        """ì‘ë‹µ í˜•ì‹ ì •ì˜"""
        return {
            "table_data": {
                "type": "table_data",
                "content": {
                    "title": "í‘œ ì œëª©",
                    "headers": ["í—¤ë”1", "í—¤ë”2"],
                    "rows": [["ë°ì´í„°1", "ë°ì´í„°2"]]
                },
                "summary": "ìš”ì•½ (ì´ Xëª…ì˜ ì „ì²´ ëª©ë¡ì…ë‹ˆë‹¤)",
                "recommendations": ["ìœ ìš©í•œ ê¶Œì¥ì‚¬í•­"]
            },
            "text": {
                "type": "text",
                "content": "ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë‹µë³€"
            },
            "crud_command": {
                "type": "crud_command",
                "command_type": "student|teacher|material|lecture",
                "action": "create|update|delete|get",
                "parameters": {
                    "id": "ìˆ˜ì •/ì‚­ì œ ì‹œ í•„ìš”",
                    "name": "ì´ë¦„",
                    "grade": "í•™ë…„",
                    "email": "ì´ë©”ì¼",
                    "subject": "ê³¼ëª©",
                    "teacher_id": "ê°•ì‚¬ ID"
                }
            },
            "analysis": {
                "type": "analysis",
                "content": {
                    "title": "ë¶„ì„ ì œëª©",
                    "data": "ë¶„ì„ ë°ì´í„°",
                    "insights": ["ì¸ì‚¬ì´íŠ¸1", "ì¸ì‚¬ì´íŠ¸2"],
                    "recommendations": ["ê¶Œì¥ì‚¬í•­1", "ê¶Œì¥ì‚¬í•­2"]
                }
            }
        }
    
    def _get_validation_rules(self) -> Dict[str, Any]:
        """ê²€ì¦ ê·œì¹™ ì •ì˜"""
        return {
            "required_fields": ["type", "content"],
            "forbidden_content": ["html", "markdown", "```", "ì¶”ê°€ ìš”ì²­í•˜ì„¸ìš”"],
            "data_validation": {
                "student_count": "ì‹¤ì œ DB í•™ìƒ ìˆ˜ì™€ ì¼ì¹˜",
                "teacher_count": "ì‹¤ì œ DB ê°•ì‚¬ ìˆ˜ì™€ ì¼ì¹˜",
                "material_count": "ì‹¤ì œ DB êµì¬ ìˆ˜ì™€ ì¼ì¹˜",
                "lecture_count": "ì‹¤ì œ DB ê°•ì˜ ìˆ˜ì™€ ì¼ì¹˜"
            },
            "format_validation": {
                "json_structure": "ì˜¬ë°”ë¥¸ JSON êµ¬ì¡°",
                "table_format": "í…Œì´ë¸” í˜•ì‹ ì¤€ìˆ˜",
                "summary_format": "ìš”ì•½ í˜•ì‹ ì¤€ìˆ˜"
            }
        }
    
    def get_full_prompt(self, context_data: Dict[str, Any], user_message: str) -> str:
        """ì „ì²´ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        # f-string ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ ë¬¸ìì—´ ì—°ê²° ì‚¬ìš©
        prompt = f"""
        {self.system_rules}
        
        {self._format_context_data(context_data)}
        
        ## ğŸ“‹ ì‘ë‹µ í˜•ì‹ ì˜ˆì‹œ
        {json.dumps(self.response_formats, ensure_ascii=False, indent=2)}
        
        ## ğŸ” ê²€ì¦ ê·œì¹™
        {json.dumps(self.validation_rules, ensure_ascii=False, indent=2)}
        
        ## ğŸ¯ í•µì‹¬ ì‹¤í–‰ ì§€ì¹¨
        
        ### ğŸ“Š ëª©ë¡ ìš”ì²­ ì²˜ë¦¬
        - í‚¤ì›Œë“œ: "ëª©ë¡", "ì „ì²´", "ì „ë¶€", "ëª¨ë“ ", "all"
        - ì‘ë‹µ: ë°˜ë“œì‹œ ëª¨ë“  ë°ì´í„° í‘œì‹œ
        - í˜•ì‹: "ì´ Xëª…ì˜ ì „ì²´ ëª©ë¡ì…ë‹ˆë‹¤"
        - ê²€ì¦: ê°œìˆ˜ì™€ ì‹¤ì œ ëª©ë¡ ê°œìˆ˜ ì¼ì¹˜
        
        ### ğŸ”¢ ê°œìˆ˜ ìš”ì²­ ì²˜ë¦¬
        - í‚¤ì›Œë“œ: "ê°œìˆ˜", "ëª‡ ëª…", "í†µê³„", "í˜„í™©"
        - ì‘ë‹µ: ì •í™•í•œ ìˆ˜ì¹˜ë§Œ
        - í˜•ì‹: "í˜„ì¬ Xëª…ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
        - ê²€ì¦: ì‹¤ì œ DB ê°œìˆ˜ì™€ ì¼ì¹˜
        
        ### ğŸ” ê²€ìƒ‰ ìš”ì²­ ì²˜ë¦¬
        - í‚¤ì›Œë“œ: "ì°¾ê¸°", "ê²€ìƒ‰", "ì–´ë””", "ëˆ„êµ¬"
        - ì‘ë‹µ: ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë§Œ
        - í˜•ì‹: "ì¡°ê±´ì— ë§ëŠ” Xëª…ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤"
        - ê²€ì¦: ê²€ìƒ‰ ì¡°ê±´ í™•ì¸
        
        ### âš™ï¸ CRUD ìš”ì²­ ì²˜ë¦¬
        - í‚¤ì›Œë“œ: "ì¶”ê°€", "ìˆ˜ì •", "ì‚­ì œ", "ë³€ê²½"
        - ì‘ë‹µ: crud_command í˜•ì‹
        - í˜•ì‹: "ëª…ë ¹ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤"
        - ê²€ì¦: ëª…ë ¹ í˜•ì‹ í™•ì¸
        
        ## ğŸš¨ ì ˆëŒ€ ê¸ˆì§€ì‚¬í•­
        - ê°€ì§œ ë°ì´í„° ìƒì„±
        - ì¼ë¶€ë§Œ í‘œì‹œ (5ê°œ, 10ê°œ ë“±)
        - ê°€ì§œ ë…¼ë¦¬ ("ê°•ì‚¬ê°€ 10ëª…ì´ë¼ì„œ...")
        - ì¶”ê°€ ìš”ì²­ ìœ ë„ ("ë” ë§ì€ ì •ë³´ë¥¼ ì›í•˜ë©´...")
        - ì˜ëª»ëœ JSON êµ¬ì¡° ({{"table_data": {{...}}}})
        - HTML/ë§ˆí¬ë‹¤ìš´ ì‚¬ìš©
        - "ì¶”ê°€ ìš”ì²­í•˜ì„¸ìš”" ë©”ì‹œì§€
        - í…Œì´ë¸” ë°ì´í„°ë¥¼ text íƒ€ì…ìœ¼ë¡œ ê°ì‹¸ê¸° ê¸ˆì§€
        - {{"type": "text", "content": "{{"table_data": {{...}}}}"}} í˜•íƒœ ê¸ˆì§€
        
        ## âœ… í•„ìˆ˜ í™•ì¸ì‚¬í•­
        - ì‹¤ì œ DB ë°ì´í„°ë§Œ ì‚¬ìš©
        - ê°œìˆ˜ì™€ ëª©ë¡ ê°œìˆ˜ ì¼ì¹˜
        - ì˜¬ë°”ë¥¸ JSON êµ¬ì¡° ì‚¬ìš©
        - í•œêµ­ì–´ ìì—°ìŠ¤ëŸ¬ìš´ ìš”ì•½
        - ì‚¬ìš©ì ì˜ë„ ì •í™•íˆ íŒŒì•…
        - í…Œì´ë¸” ë°ì´í„°ëŠ” ë°˜ë“œì‹œ {{"type": "table_data", "content": {{...}}}} í˜•íƒœë¡œ ì‘ë‹µ
        - ëª©ë¡ ìš”ì²­ ì‹œ ë°˜ë“œì‹œ table_data íƒ€ì… ì‚¬ìš©
        
        ## ì‚¬ìš©ì ì§ˆë¬¸
        {user_message}
        """
        return prompt
    
    def _format_context_data(self, context_data: Dict[str, Any]) -> str:
        """ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° í¬ë§·íŒ…"""
        student_count = len(context_data.get('students', []))
        teacher_count = len(context_data.get('teachers', []))
        material_count = len(context_data.get('materials', []))
        lecture_count = len(context_data.get('lectures', []))
        
        return f"""
        ## ğŸ¯ í˜„ì¬ ì‹œìŠ¤í…œ ì •í™•í•œ í˜„í™© (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€!)
        - **í•™ìƒ**: ì •í™•íˆ {student_count}ëª…
        - **ê°•ì‚¬**: ì •í™•íˆ {teacher_count}ëª…  
        - **êµì¬**: ì •í™•íˆ {material_count}ê°œ
        - **ê°•ì˜**: ì •í™•íˆ {lecture_count}ê°œ

        ## ğŸ“Š ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ (ì´ ë°ì´í„°ë§Œ ì‚¬ìš©!)
        {json.dumps(context_data, ensure_ascii=False, indent=2)}

        ## âš ï¸ í•µì‹¬ ì§€ì¹¨
        - ìœ„ ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ì„¸ìš” (ê°€ì§œ ë°ì´í„° ìƒì„± ê¸ˆì§€)
        - ëª©ë¡ ìš”ì²­ ì‹œ ë°˜ë“œì‹œ ì „ì²´ ë°ì´í„° í‘œì‹œ
        - ê°œìˆ˜ì™€ ì‹¤ì œ ëª©ë¡ ê°œìˆ˜ ì¼ì¹˜ í•„ìˆ˜
        - "ì´ {student_count}ëª…ì˜ ì „ì²´ ëª©ë¡ì…ë‹ˆë‹¤" í˜•íƒœ ì‚¬ìš©
        - recent_ ë°ì´í„°ëŠ” ëª©ë¡ ìš”ì²­ ì‹œ ì‚¬ìš© ê¸ˆì§€
        """ 